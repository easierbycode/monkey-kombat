<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monkey Kombat Character Select</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

    html,
    body {
      height: 100%;
    }
    
    body {
      background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
      color: #fff;
      font-family: 'Orbitron', monospace;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-image: 
        radial-gradient(circle at 25% 25%, #333 1px, transparent 1px),
        radial-gradient(circle at 75% 75%, #333 1px, transparent 1px);
      background-size: 50px 50px;
      transition: background 0.4s ease;
    }

    h1 {
      text-align: center;
      color: #ffd700;
      text-shadow: 
        0 0 5px #ffd700, 
        0 0 10px #ffd700, 
        0 0 20px #ff6600,
        0 0 40px #ff6600;
      font-size: 2.8em;
      margin: 20px 0;
      font-weight: 900;
      letter-spacing: 3px;
    }

    .select-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: calc(100vh - 120px);
      position: relative;
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #2c2c54, #40407a);
      border: 3px solid #ffd700;
      border-radius: 10px;
      box-shadow: 
        0 0 30px rgba(255, 215, 0, 0.3),
        inset 0 0 30px rgba(255, 215, 0, 0.1);
    }

    .character-tile {
      position: relative;
      aspect-ratio: 1/1;
      background: linear-gradient(135deg, #2c2c54, #1e1e3f);
      border: 2px solid #666;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      text-decoration: none;
      border-radius: 5px;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
      color: inherit;
    }

    .character-tile:hover,
    .character-tile.selected {
      border-color: #ffd700;
      background: linear-gradient(135deg, #ffd700, #ff6600);
      box-shadow: 
        0 0 20px #ffd700,
        0 0 40px #ffd700,
        inset 0 0 20px rgba(255, 215, 0, 0.2);
      transform: scale(1.08);
      z-index: 10;
    }

    .character-tile:hover .character-name,
    .character-tile.selected .character-name {
      color: #000;
      text-shadow: 0 0 5px #ffd700;
    }

    .character-tile.selected {
      animation: selectedPulse 1s infinite;
    }

    @keyframes selectedPulse {
      0% { box-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700, inset 0 0 20px rgba(255, 215, 0, 0.2); }
      50% { box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700, inset 0 0 30px rgba(255, 215, 0, 0.3); }
      100% { box-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700, inset 0 0 20px rgba(255, 215, 0, 0.2); }
    }

    .character-tile img {
      max-width: 75%;
      max-height: 75%;
      object-fit: contain;
      filter: brightness(1.1) contrast(1.2);
      transition: filter 0.2s ease;
      pointer-events: none;
    }

    .character-tile:hover img,
    .character-tile.selected img {
      filter: brightness(1.3) contrast(1.4) saturate(1.2);
    }

    .character-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      color: #ffd700;
      text-align: center;
      padding: 8px 2px;
      font-size: 0.75em;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 0 3px #000;
      transition: all 0.2s ease;
    }

    .choose {
      color: #ffd700;
      text-align: center;
      font-size: 1.2em;
      margin: 10px 0 20px 0;
      text-shadow: 0 0 10px #ffd700;
      animation: pulse 2s infinite;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .instructions {
      color: #ccc;
      text-align: center;
      font-size: 0.9em;
      margin-top: 15px;
      opacity: 0.8;
    }

    body.inLauncher .instructions {
      display: none;
    }

    @keyframes pulse {
      0% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 0.7; transform: scale(1); }
    }

    .select-container::before,
    .select-container::after {
      content: '';
      position: absolute;
      width: 100px;
      height: 100px;
      border: 3px solid #ffd700;
      z-index: -1;
    }

    .select-container::before {
      top: 50px;
      left: 50px;
      border-right: none;
      border-bottom: none;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .select-container::after {
      bottom: 50px;
      right: 50px;
      border-left: none;
      border-top: none;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    @media (orientation: landscape) and (max-height: 600px) {
      h1 {
        font-size: 1.8em;
        margin: 10px 0;
      }
      
      .choose {
        font-size: 1em;
        margin: 5px 0 10px 0;
      }
      
      .character-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 6px;
        padding: 10px;
        max-width: 95%;
      }
      
      .select-container {
        height: calc(100vh - 80px);
      }
      
      .character-tile {
        aspect-ratio: 1/1;
      }
      
      .character-name {
        font-size: 0.65em;
        padding: 4px 2px;
      }
      
      .select-container::before,
      .select-container::after {
        width: 60px;
        height: 60px;
      }

      .instructions {
        font-size: 0.8em;
        margin-top: 10px;
      }
    }

    @media (max-width: 768px) {
      .character-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-width: 95%;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .choose {
        font-size: 1em;
      }

      .instructions {
        font-size: 0.8em;
      }
    }

    body.game-active {
      background: #111;
      background-image: none;
      cursor: none;
      image-rendering: pixelated;
      overflow: hidden;
    }

    body.game-active .select-container,
    body.game-active .instructions {
      display: none;
    }

    .game-wrapper {
      position: fixed;
      inset: 0;
      display: none;
      overflow: hidden;
      box-sizing: border-box;
    }

    body.game-active .game-wrapper {
      display: block;
    }

    #gameRoot {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    #gameRoot canvas {
      image-rendering: pixelated;
    }

    .game-ui {
      position: absolute;
      top: 0px;
      left: 0px;
      z-index: 10;
      display: flex;
      gap: 12px;
      align-items: center;
      visibility: hidden;
    }

    .game-ui.visible {
      visibility: visible;
    }

    .back-button {
      background: rgba(17, 17, 17, 0.85);
      border: 2px solid #ffd700;
      color: #ffd700;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 10px 20px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s ease;
    }

    .back-button:hover {
      background: #ffd700;
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }

    .game-status {
      color: #ffd700;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    }
  </style>
  <script src="https://assets.codepen.io/11817390/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@4.0.0-rc.5/dist/phaser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="select-container" id="selectContainer">
    <h1>MONKEY KOMBAT</h1>
    <div class="choose">CHOOSE YOUR FIGHTER</div>
    
    <div class="character-grid" id="characterGrid">
      <a href="#scene-0" class="character-tile" data-index="0" data-scene="0">
        <img src="assets/cyrax.png" alt="Cyrax">
        <div class="character-name">CYRAX</div>
      </a>
      
      <a href="#scene-1" class="character-tile" data-index="1" data-scene="1">
        <img src="assets/parabomb.png" alt="Parabomb">
        <div class="character-name">PARABOMB</div>
      </a>
      
      <a href="#scene-2" class="character-tile" data-index="2" data-scene="2">
        <img src="assets/animus.png" alt="Animus">
        <div class="character-name">ANIMUS</div>
      </a>
      
      <a href="#scene-3" class="character-tile" data-index="3" data-scene="3">
        <img src="assets/liu-kang.png" alt="Liu Kang">
        <div class="character-name">LIU KANG</div>
      </a>
      
      <a href="#scene-4" class="character-tile" data-index="4" data-scene="4">
        <img src="assets/rainbow-cloud.png" alt="Rainbow Dash">
        <div class="character-name">RAINBOW DASH</div>
      </a>
      
      <a href="#scene-5" class="character-tile" data-index="5" data-scene="5">
        <img src="assets/bowser.png" alt="Bowser">
        <div class="character-name">BOWSER</div>
      </a>
      
      <a href="#scene-6" class="character-tile" data-index="6" data-scene="6">
        <img src="assets/tyson.png" alt="Mike Tyson">
        <div class="character-name">MIKE TYSON</div>
      </a>
      
      <a href="#scene-7" class="character-tile" data-index="7" data-scene="7">
        <img src="assets/beavis.png" alt="Beavis">
        <div class="character-name">BEAVIS</div>
      </a>
      
      <a href="#scene-8" class="character-tile" data-index="8" data-scene="8">
        <img src="assets/game_asset.png" alt="Scorpion">
        <div class="character-name">SCORPION</div>
      </a>
      
      <a href="#scene-9" class="character-tile" data-index="9" data-scene="9">
        <img src="assets/santa.png" alt="Santa">
        <div class="character-name">SANTA</div>
      </a>
      
      <a href="#scene-10" class="character-tile" data-index="10" data-scene="10">
        <img src="assets/sonic.png" alt="Sonic">
        <div class="character-name">SONIC</div>
      </a>
      
      <a href="#scene-11" class="character-tile" data-index="11" data-scene="11">
        <img src="assets/cat-idle.png" alt="Cat">
        <div class="character-name">CAT</div>
      </a>
    </div>

    <div class="instructions">
      Use ARROW KEYS to navigate • ENTER or SPACE to select • ESC to return from battle
    </div>
  </div>

  <div class="game-wrapper" id="gameWrapper" aria-live="polite">
    <div class="game-ui">
      <button class="back-button" id="backButton" type="button">← Character Select</button>
      <div class="game-status" id="gameStatus">Select a fighter to begin</div>
    </div>
    <div id="gameRoot"></div>
  </div>

  <script type="module">
    import { startGame, destroyGame } from './src/main.js';

    class CharacterSelect {
      constructor({ onSelect, initialIndex = 0 } = {}) {
        this.onSelect = onSelect;
        this.tiles = Array.from(document.querySelectorAll('.character-tile'));
        this.currentIndex = this.normalizeIndex(initialIndex);
        this.cols = this.getCols();
        this.handleKeydown = this.handleKeydown.bind(this);

        this.init();
      }

      normalizeIndex(index) {
        const parsed = Number.parseInt(index, 10);
        if (Number.isNaN(parsed)) {
          return 0;
        }
        return Math.min(Math.max(parsed, 0), this.tiles.length - 1);
      }

      init() {
        this.updateSelection({ scroll: false });

        document.addEventListener('keydown', this.handleKeydown);

        window.addEventListener('resize', () => {
          this.cols = this.getCols();
        });

        this.tiles.forEach((tile, index) => {
          tile.addEventListener('click', (event) => {
            if (document.body.classList.contains('game-active')) {
              return;
            }

            const sceneValue = tile.dataset.scene;
            if (typeof sceneValue === 'undefined') {
              return;
            }

            event.preventDefault();
            this.currentIndex = index;
            this.updateSelection();
            this.selectCurrent();
          });
        });
      }

      getCols() {
        if (window.matchMedia('(orientation: landscape) and (max-height: 600px)').matches) {
          return 6;
        }
        if (window.matchMedia('(max-width: 768px)').matches) {
          return 3;
        }
        return 4;
      }

      handleKeydown(event) {
        if (document.body.classList.contains('game-active')) {
          return;
        }

        switch (event.key) {
          case 'ArrowUp':
            event.preventDefault();
            this.moveUp();
            break;
          case 'ArrowDown':
            event.preventDefault();
            this.moveDown();
            break;
          case 'ArrowLeft':
            event.preventDefault();
            this.moveLeft();
            break;
          case 'ArrowRight':
            event.preventDefault();
            this.moveRight();
            break;
          case 'Enter':
          case ' ':
            event.preventDefault();
            this.selectCurrent();
            break;
          default:
            break;
        }
      }

      moveUp() {
        const currentRow = Math.floor(this.currentIndex / this.cols);
        if (currentRow > 0) {
          this.currentIndex -= this.cols;
          this.updateSelection();
        }
      }

      moveDown() {
        const newIndex = this.currentIndex + this.cols;
        if (newIndex < this.tiles.length) {
          this.currentIndex = newIndex;
          this.updateSelection();
        }
      }

      moveLeft() {
        const currentCol = this.currentIndex % this.cols;
        if (currentCol > 0) {
          this.currentIndex -= 1;
          this.updateSelection();
        }
      }

      moveRight() {
        const currentCol = this.currentIndex % this.cols;
        if (currentCol < this.cols - 1 && this.currentIndex + 1 < this.tiles.length) {
          this.currentIndex += 1;
          this.updateSelection();
        }
      }

      updateSelection({ scroll = true } = {}) {
        this.tiles.forEach((tile) => tile.classList.remove('selected'));

        const currentTile = this.tiles[this.currentIndex];
        if (!currentTile) {
          return;
        }

        currentTile.classList.add('selected');
        if (scroll) {
          currentTile.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'center',
          });
        }
      }

      selectCurrent() {
        const currentTile = this.tiles[this.currentIndex];
        if (!currentTile) {
          return;
        }

        const sceneValue = currentTile.dataset.scene;
        if (typeof sceneValue === 'undefined') {
          return;
        }

        const sceneIndex = Number.parseInt(sceneValue, 10);
        if (Number.isNaN(sceneIndex)) {
          return;
        }

        if (this.onSelect) {
          this.onSelect(sceneIndex);
        }
      }

      focus(index) {
        this.currentIndex = this.normalizeIndex(index);
        this.updateSelection({ scroll: false });
      }

      focusCurrent() {
        this.updateSelection({ scroll: false });
      }

      isValidSceneIndex(sceneIndex) {
        const parsed = Number.parseInt(sceneIndex, 10);
        return !Number.isNaN(parsed)
          && parsed >= 0
          && parsed < this.tiles.length
          && typeof this.tiles[parsed]?.dataset.scene !== 'undefined';
      }
    }

    const backButton = document.getElementById('backButton');
    const gameUi = document.querySelector('.game-ui');
    const statusLabel = document.getElementById('gameStatus');
    const params = new URLSearchParams(window.location.search);
    const debugEnabled = params.get('debug') === '1';
    const initialSceneParam = Number.parseInt(params.get('scene'), 10);

    const characterSelect = new CharacterSelect({
      onSelect: (sceneIndex) => launchScene(sceneIndex),
      initialIndex: !Number.isNaN(initialSceneParam) ? initialSceneParam : 0,
    });

    if (!Number.isNaN(initialSceneParam) && characterSelect.isValidSceneIndex(initialSceneParam)) {
      launchScene(initialSceneParam, { updateHistory: false });
    } else {
      updateUrl(null);
    }

    backButton.addEventListener('click', () => {
      exitToSelect();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && document.body.classList.contains('game-active')) {
        event.preventDefault();
        exitToSelect();
      }
    });

    document.addEventListener('enemy-defeated', () => {
      gameUi.classList.add('visible');
    });

    function launchScene(sceneIndex, { updateHistory = true } = {}) {
      const idx = Number.parseInt(sceneIndex, 10);
      if (Number.isNaN(idx)) {
        return;
      }

      document.body.classList.add('game-active');
      statusLabel.textContent = 'Press ESC to return';
      characterSelect.focus(idx);

      startGame({ sceneIndex: idx, debug: debugEnabled, parent: 'gameRoot' });

      if (updateHistory) {
        updateUrl(idx);
      }
    }

    function exitToSelect() {
      destroyGame();
      document.body.classList.remove('game-active');
      statusLabel.textContent = 'Select a fighter to begin';
      gameUi.classList.remove('visible');
      updateUrl(null);
      characterSelect.focusCurrent();
    }

    function updateUrl(sceneIndex) {
      const url = new URL(window.location.href);
      if (sceneIndex === null || typeof sceneIndex === 'undefined') {
        url.searchParams.delete('scene');
      } else {
        url.searchParams.set('scene', sceneIndex);
      }

      if (debugEnabled) {
        url.searchParams.set('debug', '1');
      } else {
        url.searchParams.delete('debug');
      }

      window.history.replaceState(null, '', url);
    }
  </script>
</body>
</html>
